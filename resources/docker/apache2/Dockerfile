FROM ubuntu:18.04
MAINTAINER Wolfgang PÃ¶hler <wolfgang.poehler@me.com>

ENV DOCUMENTROOT /var/www/public
ENV DEBIAN_FRONTEND noninteractive

RUN apt-get update && apt-get upgrade -y && apt-get install -y build-essential curl git \
    software-properties-common unzip zip

RUN apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys F3B1AA8B
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list

RUN add-apt-repository ppa:ondrej/php -y && apt-get update && apt-get clean

RUN apt-get purge --auto-remove nodejs && curl -fsSL https://deb.nodesource.com/setup_14.x | bash -

RUN apt-get update -qq && apt-get upgrade -y && apt-get install -y nodejs wget yarn apache2 python-pip \
    libapache2-mod-php7.4 php7.4 php7.4-cli php7.4-common php7.4-mysql php7.4-intl php7.4-mbstring php7.4-gd \
    php7.4-sqlite php7.4-curl php7.4-json php7.4-opcache php7.4-readline php7.4-xdebug php7.4-xml php7.4-zip

RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

RUN pip install supervisor supervisor-stdout
RUN mkdir -p /var/log/supervisor
ADD supervisord_apache2.conf /usr/local/etc/supervisord.conf

RUN a2enmod rewrite
RUN a2enmod ssl
RUN rm -fr /var/www/html
RUN mkdir -p /var/www/public
RUN chmod -R 755 /var/www/public

RUN deluser www-data
RUN groupadd -r www-data -g 1000 && useradd -u 1000 -r -g www-data -m -d /var/www -s /usr/sbin/nologin www-data

VOLUME ["/var/www"]

RUN rm /etc/apache2/sites-enabled/*
ADD 000-default.conf /etc/apache2/sites-available/000-default.conf
RUN ln -sn /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-enabled/000-default.conf
ADD default-ssl.conf /etc/apache2/sites-available/default-ssl.conf
RUN ln -sn /etc/apache2/sites-available/default-ssl.conf /etc/apache2/sites-enabled/default-ssl.conf
ADD fqdn.conf /etc/apache2/conf-available/fqdn.conf
RUN a2enconf fqdn

ADD php.ini /etc/php/7.4/apache2/php.ini
ADD xdebug.ini /etc/php/7.4/mods-available/xdebug.ini

EXPOSE 80 443

ADD run_supervisord.sh /usr/local/bin/run_supervisord.sh
RUN chmod 0755 /usr/local/bin/run_supervisord.sh
CMD ["/bin/bash", "/usr/local/bin/run_supervisord.sh"]

WORKDIR /var/www
